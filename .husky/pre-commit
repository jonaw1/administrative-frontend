#!/bin/bash

# Get the list of staged files
staged_files=$(git diff --cached --name-only --diff-filter=ACM)

# Run Prettier only on staged files
if [ -n "$staged_files" ]; then
    # Run Prettier and capture the error output
    prettier_output=$(npx prettier --write $staged_files 2>&1)

    # Check if the error output contains the "No parser could be inferred" message
    if [[ "$prettier_output" =~ "No parser could be inferred" ]]; then
        echo "Prettier check failed, but the error is ignored (No parser could be inferred)."
    elif [ $? -ne 0 ]; then
        echo "Prettier check failed. Please fix the formatting issues before committing."
        exit 1
    fi
fi

# Run ESLint only on staged files not in .eslintignore
eslint_files=$(echo "$staged_files" | grep -v -E "$(cat .eslintignore | paste -sd '|' -)")

if [ -n "$eslint_files" ]; then
    npx eslint --fix $eslint_files
fi

# Check ESLint exit code
if [ $? -ne 0 ]; then
    echo "ESLint check failed. Please fix the issues before committing."
    exit 1
fi

# Stage the modified files
git add $staged_files

# If both Prettier and ESLint passed, exit successfully
exit 0
